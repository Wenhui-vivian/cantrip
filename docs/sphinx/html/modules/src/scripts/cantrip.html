
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>src.scripts.cantrip &#8212; CANTRIP 0.1.0 documentation</title>
    <link rel="stylesheet" href="../../../static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../static/jquery.js"></script>
    <script type="text/javascript" src="../../../static/underscore.js"></script>
    <script type="text/javascript" src="../../../static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for src.scripts.cantrip</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">Iterable</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">tensorflow.python</span> <span class="k">import</span> <span class="n">debug</span> <span class="k">as</span> <span class="n">tf_debug</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.platform</span> <span class="k">import</span> <span class="n">gfile</span>

<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="k">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="k">import</span> <span class="n">trange</span><span class="p">,</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">tabulate</span> <span class="k">import</span> <span class="n">tabulate</span>

<span class="kn">from</span> <span class="nn">src.data</span> <span class="k">import</span> <span class="n">Cohort</span><span class="p">,</span> <span class="n">encode_delta_discrete</span><span class="p">,</span> <span class="n">encode_delta_continuous</span>
<span class="kn">from</span> <span class="nn">src.models</span> <span class="k">import</span> <span class="n">CANTRIPModel</span><span class="p">,</span> <span class="n">CANTRIPOptimizer</span><span class="p">,</span> <span class="n">CANTRIPSummarizer</span>
<span class="kn">from</span> <span class="nn">src.models.cantrip_model</span> <span class="k">import</span> <span class="n">CELL_TYPES</span>
<span class="kn">from</span> <span class="nn">src.models.encoder</span> <span class="k">import</span> <span class="n">rnn_encoder</span><span class="p">,</span> <span class="n">cnn_encoder</span><span class="p">,</span> <span class="n">bag_encoder</span><span class="p">,</span> <span class="n">dan_encoder</span><span class="p">,</span> <span class="n">dense_encoder</span>
<span class="kn">from</span> <span class="nn">src.models.util</span> <span class="k">import</span> <span class="n">make_dirs_quiet</span><span class="p">,</span> <span class="n">delete_dir_quiet</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1337</span><span class="p">)</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;train and evaluate CANTRIP using the given chronologies and observation &#39;</span>
                                             <span class="s1">&#39;vocabulary&#39;</span><span class="p">)</span>

<span class="c1"># Data parameters</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--chronology-path&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to cohort chronologies&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--vocabulary-path&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;path to cohort vocabulary&#39;</span><span class="p">)</span>

<span class="c1"># Chronology datastructure parameters</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--max-chron-len&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;L&#39;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;maximum number of snapshots per chronology&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--max-snapshot-size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;maximum number of observations to consider per snapshot&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--vocabulary-size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;V&#39;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;maximum vocabulary size, only the top V occurring terms will be used&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--discrete-deltas&#39;</span><span class="p">,</span> <span class="n">dest</span><span class="o">=</span><span class="s1">&#39;delta_encoder&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_const&#39;</span><span class="p">,</span>
                    <span class="n">const</span><span class="o">=</span><span class="n">encode_delta_discrete</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">encode_delta_continuous</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;rather than encoding deltas as tanh(log(delta)), &#39;</span>
                         <span class="s1">&#39;discretize them into buckets: &gt; 1 day, &gt; 2 days, &gt; 1 week, etc.&#39;</span>
                         <span class="s1">&#39;(we don</span><span class="se">\&#39;</span><span class="s1">t have enough data for this be useful)&#39;</span><span class="p">)</span>

<span class="c1"># CANTRIP: General parameters</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--dropout&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;dropout used for all dropout layers&#39;</span>
                                                              <span class="s1">&#39; (including the vocabulary)&#39;</span><span class="p">)</span>

<span class="c1"># CANTRIP: Clinical Snapshot Encoder parameters</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--observation-embedding-size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;dimensions of observation embedding vectors&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--snapshot-embedding-size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s2">&quot;dimensions of clinical snapshot encoding vectors&quot;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--snapshot-encoder&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RNN&#39;</span><span class="p">,</span> <span class="s1">&#39;CNN&#39;</span><span class="p">,</span> <span class="s1">&#39;BAG&#39;</span><span class="p">,</span> <span class="s1">&#39;DAN&#39;</span><span class="p">,</span> <span class="s1">&#39;DENSE&#39;</span><span class="p">],</span>
                    <span class="n">default</span><span class="o">=</span><span class="s1">&#39;RNN&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;type of clinical snapshot encoder to use&#39;</span><span class="p">)</span>

<span class="n">doc_encoder_rnn</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Snapshot Encoder: RNN Flags&#39;</span><span class="p">)</span>
<span class="n">doc_encoder_rnn</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--snapshot-rnn-num-hidden&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">],</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;size of hidden layer(s) used for combining clinical obserations to produce the &#39;</span>
                                  <span class="s1">&#39;clinical snapshot encoding; multiple arguments result in multiple hidden layers&#39;</span><span class="p">)</span>
<span class="n">doc_encoder_rnn</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--snapshot-rnn-cell-type&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;LSTM&#39;</span><span class="p">,</span> <span class="s1">&#39;LSTM-LN&#39;</span><span class="p">,</span> <span class="s1">&#39;GRU&#39;</span><span class="p">,</span> <span class="s1">&#39;GRU-LN&#39;</span><span class="p">,</span> <span class="s1">&#39;RAN&#39;</span><span class="p">,</span> <span class="s1">&#39;RAN-LN&#39;</span><span class="p">],</span>
                             <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">],</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;size of hidden layer(s) used for combining clinical observations to produce the &#39;</span>
                                  <span class="s1">&#39;clinical snapshot encoding; multiple arguments result in multiple hidden layers&#39;</span><span class="p">)</span>

<span class="n">doc_encoder_cnn</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Snapshot Encoder: CNN Flags&#39;</span><span class="p">)</span>
<span class="n">doc_encoder_cnn</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--snapshot-cnn-windows&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;length of convolution window(s) for CNN-based snapshot encoder; &#39;</span>
                                  <span class="s1">&#39;multiple arguments results in multiple convolution windows&#39;</span><span class="p">)</span>
<span class="n">doc_encoder_cnn</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--snapshot-cnn-kernels&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of filters used in CNN&#39;</span><span class="p">)</span>


<span class="n">doc_encoder_dan</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_argument_group</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Snapshot Encoder: DAN Falgs&#39;</span><span class="p">)</span>
<span class="n">doc_encoder_cnn</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--snapshot-dan-num-hidden-avg&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of hidden units to use when refining the DAN average layer; &#39;</span>
                                  <span class="s1">&#39;multiple arguments results in multiple dense layers&#39;</span><span class="p">)</span>
<span class="n">doc_encoder_cnn</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--snapshot-dan-num-hidden-obs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
                             <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of hidden units to use when refining clinical observation embeddings; &#39;</span>
                                  <span class="s1">&#39;multiple arguments results in multiple dense layers&#39;</span><span class="p">)</span>

<span class="c1"># CANTRIP: Clinical Picture Inference parameters</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--rnn-num-hidden&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">],</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;size of hidden layer(s) used for inferring the clinical picture; &#39;</span>
                         <span class="s1">&#39;multiple arguments result in multiple hidden layers&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--rnn-cell-type&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">CELL_TYPES</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;LSTM&#39;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;type of RNN cell to use for inferring the clinical picture&#39;</span><span class="p">)</span>

<span class="c1"># Experimental setting parameters</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--batch-size&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;batch size&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--num-epochs&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;number of training epochs&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--tdt-ratio&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;8:1:1&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;training:development:testing ratio&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--early-term&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;stop when F1 on dev set decreases; &#39;</span>
                                                                             <span class="s1">&#39;this is pretty much always a bad idea&#39;</span><span class="p">)</span>

<span class="c1"># TensorFlow-specific settings</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--summary-dir&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;data/working/summaries&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--checkpoint-dir&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;models/checkpoints&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--clear&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                    <span class="n">help</span><span class="o">=</span><span class="s1">&#39;remove previous summary/checkpoints before starting this run&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--debug&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;hostname:port of TensorBoard debug server&#39;</span><span class="p">)</span>

<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--print-performance&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--print-latex-results&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">)</span>


<span class="c1"># TODO: break the file into separate training/testing/inference phases</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--mode&#39;</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;TRAIN&#39;</span><span class="p">],</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;TRAIN&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">SUPPRESS</span><span class="p">)</span>


<div class="viewcode-block" id="make_train_devel_test_split"><a class="viewcode-back" href="../../../src.scripts.html#src.scripts.cantrip.make_train_devel_test_split">[docs]</a><span class="k">def</span> <span class="nf">make_train_devel_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">ratio</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">Iterable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split the given dataset into training, development, and testing sets using the given ratio</span>
<span class="sd">    e.g., split(data, \&#39;8:1:1\&#39;) splits 80% as training, 10% as development, and 10% as testing</span>
<span class="sd">    :param data: dataset to split</span>
<span class="sd">    :param ratio: ratio encoded as a string, specified as train:devel:test</span>
<span class="sd">    :return: a triple containing the training, development, and testing sets</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Parse the splitting ratio</span>
    <span class="n">train</span><span class="p">,</span> <span class="n">devel</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ratio</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)]</span>

    <span class="c1"># First split into training+development and test</span>
    <span class="n">train_devel</span><span class="p">,</span> <span class="n">_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="p">(</span><span class="n">test</span> <span class="o">/</span> <span class="p">(</span><span class="n">train</span> <span class="o">+</span> <span class="n">devel</span> <span class="o">+</span> <span class="n">test</span><span class="p">)))</span>
    <span class="c1"># Then split training+development into training and development</span>
    <span class="n">_train</span><span class="p">,</span> <span class="n">_devel</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">train_devel</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="p">(</span><span class="n">devel</span> <span class="o">/</span> <span class="p">(</span><span class="n">train</span> <span class="o">+</span> <span class="n">devel</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">_train</span><span class="p">,</span> <span class="n">_devel</span><span class="p">,</span> <span class="n">_test</span></div>


<div class="viewcode-block" id="run_model"><a class="viewcode-back" href="../../../src.scripts.html#src.scripts.cantrip.run_model">[docs]</a><span class="k">def</span> <span class="nf">run_model</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">CANTRIPModel</span><span class="p">,</span> <span class="n">cohort</span><span class="p">:</span> <span class="n">Cohort</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the given model using the given cohort and experimental settings contained in args.</span>

<span class="sd">    This function:</span>
<span class="sd">    (1) balanced the dataset</span>
<span class="sd">    (2) splits the cohort intro training:development:testing sets at the patient-level</span>
<span class="sd">    (3) trains CANTRIP and saves checkpoint/summaries for TensorBoard</span>
<span class="sd">    (4) evaluates CANTRIP on the development and testing set</span>
<span class="sd">    :param model: an instantiated CANTRIP model</span>
<span class="sd">    :param cohort: the cohort to use for this experimental run</span>
<span class="sd">    :param args: command-line arguments specifying model/experiment parameters</span>
<span class="sd">    :return: nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Balance the cohort to have an even number of positive/negative chronologies for each patient</span>
    <span class="n">cohort</span> <span class="o">=</span> <span class="n">cohort</span><span class="o">.</span><span class="n">balance_chronologies</span><span class="p">()</span>

    <span class="c1"># Split into training:development:testing</span>
    <span class="n">train</span><span class="p">,</span> <span class="n">devel</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">make_train_devel_test_split</span><span class="p">(</span><span class="n">cohort</span><span class="o">.</span><span class="n">patients</span><span class="p">(),</span> <span class="n">args</span><span class="o">.</span><span class="n">tdt_ratio</span><span class="p">)</span>

    <span class="c1"># Save summaries and checkpoints into the directories passed to the script</span>
    <span class="n">model_summaries_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">summary_dir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">rnn_cell_type</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">snapshot_encoder</span><span class="p">)</span>
    <span class="n">model_checkpoint_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">checkpoint_dir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">rnn_cell_type</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">snapshot_encoder</span><span class="p">)</span>

    <span class="c1"># Clear any previous summaries/checkpoints if asked</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">clear</span><span class="p">:</span>
        <span class="n">delete_dir_quiet</span><span class="p">(</span><span class="n">model_summaries_dir</span><span class="p">)</span>
        <span class="n">delete_dir_quiet</span><span class="p">(</span><span class="n">model_checkpoint_dir</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Deleted previous model summaries/checkpoints&#39;</span><span class="p">)</span>

    <span class="c1"># Make output directories so we don&#39;t blow up when saving</span>
    <span class="n">make_dirs_quiet</span><span class="p">(</span><span class="n">model_checkpoint_dir</span><span class="p">)</span>

    <span class="c1"># Instantiate CANTRIP optimizer and summarizer classes</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">CANTRIPOptimizer</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">summarizer</span> <span class="o">=</span> <span class="n">CANTRIPSummarizer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">)</span>

    <span class="c1"># Now that everything has been defined in TensorFlow&#39;s computation graph, initialize our model saver</span>
    <span class="n">saver</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">Saver</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">global_variables</span><span class="p">())</span>

    <span class="c1"># Tell TensorFlow to wake up and get ready to rumble</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">Session</span><span class="p">()</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>

        <span class="c1"># If we specified a TensorBoard debug server, connect to it</span>
        <span class="c1"># (this is actually pretty sweet but you have to manually step through your model&#39;s flow so 99% of the time</span>
        <span class="c1"># you shouldn&#39;t need it)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sess</span> <span class="o">=</span> <span class="n">tf_debug</span><span class="o">.</span><span class="n">TensorBoardDebugWrapperSession</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>

        <span class="c1"># Create our summary writer (used by TensorBoard)</span>
        <span class="n">summary_writer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">FileWriter</span><span class="p">(</span><span class="n">model_summaries_dir</span><span class="p">,</span> <span class="n">sess</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>

        <span class="c1"># Restore model if it exists (and we didn&#39;t clear it), otherwise create a shiny new one</span>
        <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">get_checkpoint_state</span><span class="p">(</span><span class="n">model_checkpoint_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">checkpoint</span> <span class="ow">and</span> <span class="n">gfile</span><span class="o">.</span><span class="n">Exists</span><span class="p">(</span><span class="n">checkpoint</span><span class="o">.</span><span class="n">model_checkpoint_path</span> <span class="o">+</span> <span class="s1">&#39;.index&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reading model parameters from &#39;</span><span class="si">%s</span><span class="s2">&#39;...&quot;</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">model_checkpoint_path</span><span class="p">)</span>
            <span class="n">saver</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">checkpoint</span><span class="o">.</span><span class="n">model_checkpoint_path</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating model with fresh parameters...&quot;</span><span class="p">)</span>
            <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">global_variables_initializer</span><span class="p">())</span>

        <span class="c1"># Initialize local variables (these are just used for computing average metrics)</span>
        <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">local_variables_initializer</span><span class="p">())</span>

        <span class="c1"># Create a progress logger to monitor training (this is a wrapped version of range()</span>
        <span class="k">with</span> <span class="n">trange</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">num_epochs</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Training&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">train_log</span><span class="p">:</span>
            <span class="c1"># Save the training, development, and testing metrics for our best model (as measured by devel F1)</span>
            <span class="c1"># I&#39;m lazy so I initialize best_devel_metrics with a zero F1 so I can compare the first iteration to it</span>
            <span class="n">best_train_metrics</span><span class="p">,</span> <span class="n">best_devel_metrics</span><span class="p">,</span> <span class="n">best_test_metrics</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{</span><span class="s1">&#39;F1&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span> <span class="p">{}</span>
            <span class="c1"># Iterate over training epochs</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">train_log</span><span class="p">:</span>
                <span class="c1"># Get global step and reset training metrics</span>
                <span class="n">global_step</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">optimizer</span><span class="o">.</span><span class="n">global_step</span><span class="p">,</span> <span class="n">summarizer</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">reset_op</span><span class="p">])</span>
                <span class="c1"># Log our progress on the current epoch using tqdm cohort.make_epoch_batches shuffles the order of</span>
                <span class="c1"># chronologies and prepares them  into mini-batches with zero-padding if needed</span>
                <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">cohort</span><span class="p">[</span><span class="n">train</span><span class="p">]</span><span class="o">.</span><span class="n">make_epoch_batches</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)),</span> <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;Epoch </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">as</span> <span class="n">batch_log</span><span class="p">:</span>
                    <span class="c1"># Iterate over each batch</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">batch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">batch_log</span><span class="p">):</span>
                        <span class="c1"># We train the model by evaluating the optimizer&#39;s training op. At the same time we update the</span>
                        <span class="c1"># training metrics and get metrics/summaries for the current batch and request the new global</span>
                        <span class="c1"># step number (used by TensorBoard to coordinate metrics across different runs</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">batch_summary</span><span class="p">,</span> <span class="n">batch_metrics</span><span class="p">,</span> <span class="n">global_step</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                            <span class="p">[[</span><span class="n">optimizer</span><span class="o">.</span><span class="n">train_op</span><span class="p">,</span> <span class="n">summarizer</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">metric_ops</span><span class="p">],</span>  <span class="c1"># All fetches we arent going to read</span>
                             <span class="n">summarizer</span><span class="o">.</span><span class="n">batch_summary</span><span class="p">,</span> <span class="n">summarizer</span><span class="o">.</span><span class="n">batch_metrics</span><span class="p">,</span>
                             <span class="n">optimizer</span><span class="o">.</span><span class="n">global_step</span><span class="p">],</span>
                            <span class="n">batch</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>

                        <span class="c1"># Update tqdm progress indicator with current training metrics on this batch</span>
                        <span class="n">batch_log</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">batch_metrics</span><span class="p">)</span>

                        <span class="c1"># Save batch-level summaries</span>
                        <span class="n">summary_writer</span><span class="o">.</span><span class="n">add_summary</span><span class="p">(</span><span class="n">batch_summary</span><span class="p">,</span> <span class="n">global_step</span><span class="o">=</span><span class="n">global_step</span><span class="p">)</span>

                <span class="c1"># Save epoch-level training metrics and summaries</span>
                <span class="n">train_metrics</span><span class="p">,</span> <span class="n">train_summary</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">summarizer</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">summarizer</span><span class="o">.</span><span class="n">train</span><span class="o">.</span><span class="n">summary</span><span class="p">])</span>
                <span class="n">summary_writer</span><span class="o">.</span><span class="n">add_summary</span><span class="p">(</span><span class="n">train_summary</span><span class="p">,</span> <span class="n">global_step</span><span class="o">=</span><span class="n">global_step</span><span class="p">)</span>

                <span class="c1"># Evaluate development performance</span>
                <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">summarizer</span><span class="o">.</span><span class="n">devel</span><span class="o">.</span><span class="n">reset_op</span><span class="p">)</span>
                <span class="c1"># Update local variables used to compute development metrics as we process each batch</span>
                <span class="k">for</span> <span class="n">devel_batch</span> <span class="ow">in</span> <span class="n">cohort</span><span class="p">[</span><span class="n">devel</span><span class="p">]</span><span class="o">.</span><span class="n">make_epoch_batches</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
                    <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">summarizer</span><span class="o">.</span><span class="n">devel</span><span class="o">.</span><span class="n">metric_ops</span><span class="p">],</span> <span class="n">devel_batch</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
                <span class="c1"># Compute the development metrics</span>
                <span class="n">devel_metrics</span><span class="p">,</span> <span class="n">devel_summary</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">summarizer</span><span class="o">.</span><span class="n">devel</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">summarizer</span><span class="o">.</span><span class="n">devel</span><span class="o">.</span><span class="n">summary</span><span class="p">])</span>
                <span class="c1"># Update training progress bar to indicate current performance on development set</span>
                <span class="n">train_log</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">devel_metrics</span><span class="p">)</span>
                <span class="c1"># Save TensorBoard summary</span>
                <span class="n">summary_writer</span><span class="o">.</span><span class="n">add_summary</span><span class="p">(</span><span class="n">devel_summary</span><span class="p">,</span> <span class="n">global_step</span><span class="o">=</span><span class="n">global_step</span><span class="p">)</span>

                <span class="c1"># Evaluate testing performance exactly as described above for development</span>
                <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">summarizer</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">reset_op</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">cohort</span><span class="p">[</span><span class="n">test</span><span class="p">]</span><span class="o">.</span><span class="n">make_epoch_batches</span><span class="p">(</span><span class="o">**</span><span class="nb">vars</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
                    <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">summarizer</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">summarizer</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">metric_ops</span><span class="p">],</span> <span class="n">batch</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">model</span><span class="p">))</span>
                <span class="n">test_metrics</span><span class="p">,</span> <span class="n">test_summary</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">summarizer</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">metrics</span><span class="p">,</span> <span class="n">summarizer</span><span class="o">.</span><span class="n">test</span><span class="o">.</span><span class="n">summary</span><span class="p">])</span>
                <span class="n">summary_writer</span><span class="o">.</span><span class="n">add_summary</span><span class="p">(</span><span class="n">test_summary</span><span class="p">,</span> <span class="n">global_step</span><span class="o">=</span><span class="n">global_step</span><span class="p">)</span>

                <span class="c1"># If this run did better on the dev set, save it as the new best model</span>
                <span class="k">if</span> <span class="n">devel_metrics</span><span class="p">[</span><span class="s1">&#39;F1&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">best_devel_metrics</span><span class="p">[</span><span class="s1">&#39;F1&#39;</span><span class="p">]:</span>
                    <span class="n">best_devel_metrics</span> <span class="o">=</span> <span class="n">devel_metrics</span>
                    <span class="n">best_train_metrics</span> <span class="o">=</span> <span class="n">train_metrics</span>
                    <span class="n">best_test_metrics</span> <span class="o">=</span> <span class="n">test_metrics</span>
                    <span class="c1"># Save the model</span>
                    <span class="n">saver</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="n">model_checkpoint_dir</span><span class="p">,</span> <span class="n">global_step</span><span class="o">=</span><span class="n">global_step</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">early_term</span><span class="p">:</span>
                    <span class="n">tqdm</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;Early termination!&#39;</span><span class="p">)</span>
                    <span class="k">break</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Training complete!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">print_performance</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Train: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">best_train_metrics</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Devel: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">best_devel_metrics</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Test: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">best_test_metrics</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">print_latex_results</span><span class="p">:</span>
            <span class="n">print_latex_results</span><span class="p">(</span><span class="n">best_train_metrics</span><span class="p">,</span> <span class="n">best_devel_metrics</span><span class="p">,</span> <span class="n">best_test_metrics</span><span class="p">)</span></div>


<div class="viewcode-block" id="print_latex_results"><a class="viewcode-back" href="../../../src.scripts.html#src.scripts.cantrip.print_latex_results">[docs]</a><span class="k">def</span> <span class="nf">print_latex_results</span><span class="p">(</span><span class="n">train</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">devel</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">test</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Prints results in a LaTeX-style table to the console</span>

<span class="sd">    :param train: training metrics</span>
<span class="sd">    :param devel: development metrics</span>
<span class="sd">    :param test: testing metrics</span>
<span class="sd">    :return: nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_evaluate</span><span class="p">(</span><span class="n">dataset</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fetch the given metrics from the given dataset metric dictionary in the order they were given</span>
<span class="sd">        :param dataset: dictionary containg metrics for a specific dataset</span>
<span class="sd">        :param metrics: list of metric names to fetch</span>
<span class="sd">        :return: list of metric values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">metrics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;Precision&#39;</span><span class="p">,</span> <span class="s1">&#39;Recall&#39;</span><span class="p">,</span> <span class="s1">&#39;F1&#39;</span><span class="p">,</span> <span class="s1">&#39;AUROC&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">dataset</span><span class="p">[</span><span class="n">metric</span><span class="p">]</span> <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">]</span>

    <span class="c1"># Create a LaTeX table using tabulate</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">tabulate</span><span class="p">([</span><span class="n">_evaluate</span><span class="p">(</span><span class="n">train</span><span class="p">),</span>
                      <span class="n">_evaluate</span><span class="p">(</span><span class="n">devel</span><span class="p">),</span>
                      <span class="n">_evaluate</span><span class="p">(</span><span class="n">test</span><span class="p">)],</span>
                     <span class="n">headers</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Acc.&#39;</span><span class="p">,</span> <span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="s1">&#39;R&#39;</span><span class="p">,</span> <span class="s1">&#39;F1&#39;</span><span class="p">,</span> <span class="s1">&#39;AUC&#39;</span><span class="p">],</span>
                     <span class="n">tablefmt</span><span class="o">=</span><span class="s1">&#39;latex&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">table</span><span class="p">)</span></div>


<div class="viewcode-block" id="main"><a class="viewcode-back" href="../../../src.scripts.html#src.scripts.cantrip.main">[docs]</a><span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main method for the script. Parses arguments and calls run_model.</span>
<span class="sd">    :param argv: commandline arguments</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

    <span class="c1"># Load cohort</span>
    <span class="n">cohort</span> <span class="o">=</span> <span class="n">Cohort</span><span class="o">.</span><span class="n">from_disk</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">chronology_path</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">vocabulary_path</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">vocabulary_size</span><span class="p">)</span>

    <span class="c1"># Compute vocabulary size (it may be smaller than args.vocabulary_size)</span>
    <span class="n">vocabulary_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cohort</span><span class="o">.</span><span class="n">vocabulary</span><span class="p">)</span>

    <span class="c1"># The embedding size is the same as the word embedding size unless using the BAG encoder</span>
    <span class="n">observation_embedding_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">observation_embedding_size</span>

    <span class="c1"># Parse snapshot-encoder-specific arguments</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">snapshot_encoder</span> <span class="o">==</span> <span class="s1">&#39;RNN&#39;</span><span class="p">:</span>
        <span class="n">snapshot_encoder</span> <span class="o">=</span> <span class="n">rnn_encoder</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">snapshot_rnn_num_hidden</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">snapshot_encoder</span> <span class="o">==</span> <span class="s1">&#39;CNN&#39;</span><span class="p">:</span>
        <span class="n">snapshot_encoder</span> <span class="o">=</span> <span class="n">cnn_encoder</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">snapshot_cnn_windows</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">snapshot_cnn_num_kernels</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">dropout</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">snapshot_encoder</span> <span class="o">==</span> <span class="s1">&#39;BAG&#39;</span><span class="p">:</span>
        <span class="n">snapshot_encoder</span> <span class="o">=</span> <span class="n">bag_encoder</span>
        <span class="n">observation_embedding_size</span> <span class="o">=</span> <span class="n">vocabulary_size</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">snapshot_encoder</span> <span class="o">==</span> <span class="s1">&#39;DENSE&#39;</span><span class="p">:</span>
        <span class="n">snapshot_encoder</span> <span class="o">=</span> <span class="n">dense_encoder</span>
    <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">snapshot_encoder</span> <span class="o">==</span> <span class="s1">&#39;DAN&#39;</span><span class="p">:</span>
        <span class="n">snapshot_encoder</span> <span class="o">=</span> <span class="n">dan_encoder</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">snapshot_dan_num_hidden_obs</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">snapshot_dan_num_hidden_avg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Given illegal snapshot encoder </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">args</span><span class="o">.</span><span class="n">doc_encoder</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">CANTRIPModel</span><span class="p">(</span><span class="n">max_seq_len</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_chron_len</span><span class="p">,</span>
                         <span class="n">max_snapshot_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">max_snapshot_size</span><span class="p">,</span>
                         <span class="n">vocabulary_size</span><span class="o">=</span><span class="n">vocabulary_size</span><span class="p">,</span>
                         <span class="n">observation_embedding_size</span><span class="o">=</span><span class="n">observation_embedding_size</span><span class="p">,</span>
                         <span class="n">num_hidden</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">rnn_num_hidden</span><span class="p">,</span>
                         <span class="n">cell_type</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">rnn_cell_type</span><span class="p">,</span>
                         <span class="n">batch_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
                         <span class="n">snapshot_encoder</span><span class="o">=</span><span class="n">snapshot_encoder</span><span class="p">,</span>
                         <span class="n">dropout</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
                         <span class="n">num_classes</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                         <span class="n">delta_encoding_size</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">delta_encoder</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;TRAIN&#39;</span><span class="p">:</span>
        <span class="n">run_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">cohort</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">CANTRIP</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Travis R. Goodwin.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>